{% extends 'mog/base.html' %}

{% load filters %}
{% load humanize %}
{% load i18n %}

{% block title %}{{ contest.name }} | {% trans 'Standing' %}{% endblock %}

{% block styles %}
    <style>
        table > thead > tr > th {
            font-weight: 600;
            font-size: 14px;
            background-color: #F7F8F9;
        }

        table > thead > tr > th > a {
            display: block;
            padding: 10px;
            text-decoration: none !important;
        }

        table > thead > tr > th > a:hover {
            text-decoration: none !important;
        }

        table > thead > tr > th > a.black-text {
            color: #000000 !important;
        }

        table > thead > tr > th:nth-child(1),
        table > thead > tr > th:nth-child(2),
        table > thead > tr > th:nth-child(3),
        table > thead > tr > th:nth-child(4)
        {
            padding: 18px 8px !important;
        }
    </style>
{% endblock %}

{% block main %}
    <div class="row">
        <div class="col-md-12 text-center">
            <h1 class="title">{% trans 'Standing'  %}</h1>
            <h3 class="title"><a href="{% url 'mog:contest_problems' contest.pk %}">{{ contest.name }}</a></h3>
            {% if user_instance %}
                {% if user_instance.is_running %}
                    <h5 class="title">
                        {{ user_instance.relative_time|format_seconds }} / -{{ user_instance.remaining_time|format_seconds }}
                    </h5>
                    {% if not user_instance.real %}
                        <h5>(virtual)</h5>
                    {% endif %}
                {% endif %}
            {% else %}
                {% if contest.is_running %}
                    <h5 class="title">
                        <span class="time-update" data-enabled="on" data-delta="+1" data-upper="{{ contest.duration.total_seconds }}">{{ contest.relative_time|format_seconds }}</span>
                        /
                        -<span class="time-update" data-enabled="on" data-delta="-1">{{ contest.remaining_time|format_seconds }}</span>
                    </h5>
                {% endif %}
            {% endif %}
        </div>

        <div class="col-md-12">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th class="cell-small">{% trans 'Rank' %}</th>
                        <th>{% trans 'Contestant' %} / {% trans 'Team' %}</th>
                        <th class="text-center cell-small">{% trans 'Solved' %}</th>
                        <th class="text-center cell-small">{% trans 'Penalty' %}</th>
                        {% for problem in problems %}
                            <th class="text-center cell-medium">
                                <a data-toggle="tooltip" href="{% url 'mog:problem' problem.id problem.slug %}" title="{{ problem.title }}"
                                   {% if problem.balloon and problem.balloon.0 == '#' %}
                                       {% if problem.balloon == '#ffffff' %}
                                           class="black-text"
                                       {% endif %}
                                       style="color: white; background: no-repeat center/25px url('data:image/svg+xml;utf8,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; viewBox=&quot;0 0 17.5 20.2&quot;><path fill=&quot; {{ problem.balloon|urlencode }} &quot; d=&quot;M17.5 8.3c0 6-8.7 11.8-8.7 11.8S0 14.3 0 8.3C0 3.7 3.9 0 8.7 0S17.5 3.7 17.5 8.3z&quot;/></svg>');"
                                   {% endif %}
                                >
                                    {{ problem.letter }}
                                </a>
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for instance_result in instance_results %}
                        {% with instance=instance_result.instance %}
                            <tr class="standing-row">
                                <td class="text-center">{{ instance_result.rank }}</td>
                                <td>
                                    <div style="min-height: 45px;">
                                        {% if not instance.real %}
                                            (~)
                                        {% endif %}

                                        {% if instance.team %}
                                            {% include 'mog/team/_link.html' with team=instance.team %}
                                            {% with institution=instance.team.institution %}
                                                {% if institution %}
                                                    <small>{{ institution.name }}</small>
                                                {% endif %}
                                            {% endwith %}
                                        {% else %}
                                            {% include 'mog/user/_link.html' with user=instance.user %}
                                            {% with institution=instance.user.profile.institution %}
                                                {% if institution %}
                                                    <p><small>{{ institution.name }}</small></p>
                                                {% endif %}
                                            {% endwith %}
                                        {% endif %}
                                    </div>
                                </td>

                                <td class="text-center">{{ instance_result.solved }}</td>

                                <td class="text-center">
                                    {{ instance_result.penalty|format_penalty }}
                                </td>

                                {% for problem_result in instance_result.problem_results %}
                                    {% if problem_result.accepted %}
                                        {% if problem_result.first_all %}
                                            <td class="text-center contest-solved-first">
                                        {% elif problem_result.first %}
                                            <td class="text-center problem-solved-first">
                                        {% else %}
                                            <td class="text-center problem-solved">
                                        {% endif %}
                                    {% elif problem_result.attempts > 0 %}
                                        <td class="text-center problem-failed">
                                    {% else %}
                                        <td class="text-center">
                                    {% endif %}
                                            {% if problem_result.accepted %}
                                                <div>
                                                    {{ problem_result.acc_delta|format_minutes }}
                                                </div>
                                            {% endif %}
                                            {% if problem_result.attempts > 0 %}
                                                <small>(-{{ problem_result.attempts }})</small>
                                            {% endif %}
                                        </td>
                                {% endfor %}
                            </tr>
                        {% endwith %}
                    {% empty %}
                        <tr>
                            <td colspan="{{ problems|length|add:4 }}">
                                {% trans 'No one registered for this contest!' %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="col-md-12">
            <form action="{% url 'mog:contest_standing' contest.pk %}" method="get" style="margin-left: 20px !important;">
                <div class="checkbox">
                    <input id="show_virtual" type="checkbox" name="show_virtual"
                           onclick="$(this).closest('form').submit();" {% if show_virtual %}checked="checked"{% endif %}>
                    <label for="show_virtual">
                        {% trans 'Show virtual participation' %} (~)
                    </label>
                </div>
            </form>
        </div>
    </div>
{% endblock %}