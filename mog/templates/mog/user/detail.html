{% extends 'mog/user/profile.html' %}

{% load filters %}
{% load static %}

{% block _detail %}active{% endblock %}

{% block content2 %}
    <div class="row">
        <div class="col-md-12">
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th class="text-center">Rating</th>
                        <th class="text-center">Points</th>
                        <th class="text-center">Solved</th>
                        <th class="text-center">Accepted</th>
                        <th class="text-center">Submissions</th>
                        <th class="text-center">Teams</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        {% with data=user_in_profile|user_stats %}
                            <td class="text-center">{{ data.rating }}</td>
                            <td class="text-center">{{ data.points }}</td>
                            <td class="text-center">{{ data.solved }}</td>
                            <td class="text-center">
                                <a class="no-underline"
                                   href="{% url 'mog:submissions' %}?username={{ user_in_profile.username }}&result={{ 'accepted'|result_id }}">{{ data.accepted }}</a>
                            </td>
                            <td class="text-center">
                                <a class="no-underline"
                                   href="{% url 'mog:submissions' %}?username={{ user_in_profile.username }}">{{ data.submissions }}</a>
                            </td>
                            <td class="text-center">{{ user_in_profile.profile.teams.all|length }}</td>
                        {% endwith %}
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="col-md-12">
            <div class="well" style="background-color: white;">
                <div id="user-graph"></div>
            </div>
        </div>
    </div>
{% endblock %}

{% block styles %}
    <link href="{% static 'mog/plugins/morris/css/morris.min.css' %}" rel="stylesheet"/>
{% endblock %}

{% block scripts %}
    <script type="text/javascript" src="{% static 'mog/plugins/raphael/js/raphael-2.0.2.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'mog/plugins/morris/js/morris.min.js' %}"></script>

    <script type="text/javascript">
        $(document).ready(function() {
            var data = [
                {% for r in user_in_profile.profile.get_ratings %}
                    {% if forloop.counter > 1 %},{% endif %}
                    { date: '{{ r.date }}', name: '{{ r.name }}', url: '{{ r.url }}', rating: {{ r.rating }}, change: {{ r.change }} }
                {% endfor %}
            ];

            if (data.length === 0) {
                $('div#user-graph').parent().parent().remove();
                return;
            }

            var divisionRatings = [], divisionColors = [];
            {% for division in divisions %}
                divisionRatings.push({{ division.rating }});
                divisionColors.push('{{ division.color }}');
            {% endfor %}


            var minRating = divisionRatings[divisionRatings.length - 1] - 200;
            var maxRating = divisionRatings[divisionRatings.length - 1] + 200;

            data.forEach(function(rc) {
                if (minRating === undefined || minRating > rc.rating) minRating = rc.rating;
                if (maxRating === undefined || maxRating < rc.rating) maxRating = rc.rating;
            });

            minRating = Math.trunc((minRating - 200) / 200) * 200;
            maxRating = Math.trunc((maxRating + 200) / 200) * 200;

            Morris.Line({
                element: 'user-graph',
                data: data,
                xkey: 'date',
                ykeys: ['rating'],
                labels: ['Rating'],
                parseTime: true,
                yLabelFormat: function(y) {
                    return Math.trunc(y);
                },
                xLabels: "month",
                lineWidth: 3,
                ymin: minRating,
                ymax: maxRating,
                hideHover: "auto",
                goals: divisionRatings,
                gridLineColor: '#aaa',
                goalLineColors: divisionColors,
                continuousLine: false,
                hoverCallback: function (index, options, content) {
                    var row = options.data[index];
                    var change = '';
                    if (row.change < 0) change = '(-' + row.change + ')';
                    if (row.change > 0) change = '(+' + row.change + ')';
                    var html = [
                        '<p>',
                        '    <a href="' + row.url + '">' + row.name + '</a>',
                        '    <br />',
                        '    Rank: ' + row.rank,
                        '    <br />',
                        '    Rating: ' + row.rating + change,
                        '</p>'
                    ];
                    return html.join('');
                }
            });
        });
    </script>
{% endblock %}
